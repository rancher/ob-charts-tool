name: Produce PR Artifacts

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number to build image for'
        required: true
        type: number

concurrency:
  group: prs-${{ github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0
      - run: git fetch --force --tags
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version: 1.24
      - uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean
      -
        name: Upload assets
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: myapp
          path: ./dist/*

  comment-on-pr:
    name: Comment on PR with artifact links
    runs-on: ubuntu-latest
    needs:
      - goreleaser
    permissions:
      pull-requests: write
      actions: read
    steps:
      - name: Comment on PR with artifact links
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          prNumber: ${{ github.event.inputs.pr_number }}
        with:
          script: |
            const prNumber = Number(process.env.prNumber);
            if (!prNumber) {
              core.setFailed('pr_number input is required to comment on a PR.');
            }

            // List artifacts for the current workflow run
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
              per_page: 100,
            });

            const artifacts = data.artifacts || [];

            let bodyLines = [];
            bodyLines.push(`### Artifacts produced for PR #${prNumber}:`);
            if (artifacts.length === 0) {
              bodyLines.push('\nNo artifacts were found for this run.');
            } else {
              bodyLines.push('\nThe following artifacts are available:');
              for (const art of artifacts) {
                // archive_download_url requires authentication; that's fine for repo members viewing the PR.
                bodyLines.push(`- ${art.name} (size ~${Math.round((art.size_in_bytes || 0)/1024)} KB) - [Download](${art.archive_download_url})`);
              }

              // Also include a link to the run page where artifacts are listed in the UI
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              bodyLines.push(`\nView all artifacts in the Actions run: ${runUrl}`);
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: bodyLines.join('\n')
            });